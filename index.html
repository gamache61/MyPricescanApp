<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Price Scanner Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00ff00">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #000; color: white; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        #camera-container { position: relative; height: 45vh; background: #000; border-bottom: 2px solid #333; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #viewfinder { width: 250px; height: 250px; border: 4px solid #00ff00; border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); }
        #controls { height: 25vh; background: #1a1a1a; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 10px; }
        #snap-btn { width: 95%; height: 75px; font-size: 2rem; font-weight: bold; background: #00ff00; border: none; border-radius: 15px; color: black; }
        .row { width: 95%; display: flex; gap: 10px; }
        .btn-small { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #444; background: #222; color: white; font-weight: bold; }
        #footer { height: 30vh; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #status { color: #ffcc00; font-weight: bold; margin-bottom: 5px; }
        .total-display { font-size: 5.5rem; font-weight: 900; color: #00ff00; line-height: 1; }
        #debug-canvas { position: absolute; top: 10px; left: 10px; width: 140px; height: 140px; border: 2px solid red; background: white; z-index: 100; }
    </style>
</head>
<body>
    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div id="overlay"><div id="viewfinder"></div></div>
        <canvas id="debug-canvas"></canvas>
    </div>
    <div id="controls">
        <button id="snap-btn">SNAP PRICE</button>
        <div class="row">
            <button class="btn-small" onclick="toggleFlash()">FLASH</button>
            <button class="btn-small" style="color:#ff8888" onclick="undoLast()">UNDO</button>
            <button class="btn-small" onclick="resetTotal()">CLEAR</button>
        </div>
    </div>
    <div id="footer">
        <div id="status">Loading...</div>
        <div class="total-display">$<span id="total">0.00</span></div>
    </div>
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('debug-canvas');
        const totalDisp = document.getElementById('total');
        const status = document.getElementById('status');
        const snapBtn = document.getElementById('snap-btn');
        let currentTotal = 0, scanHistory = [], worker = null, videoTrack = null, flashOn = false;

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 } } });
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];
                worker = await Tesseract.createWorker('eng');
                await worker.setParameters({ tessedit_char_whitelist: '0123456789.', tessedit_pageseg_mode: '7' });
                status.innerText = "READY";
            } catch (e) { status.innerText = "Camera Error"; }
        }

        async function toggleFlash() {
            if (!videoTrack) return;
            flashOn = !flashOn;
            await videoTrack.applyConstraints({ advanced: [{ torch: flashOn }] });
        }

        snapBtn.onclick = async () => {
            status.innerText = "Reading...";
            const ctx = canvas.getContext('2d');
            const vWidth = video.videoWidth, vHeight = video.videoHeight;
            const scanSize = Math.min(vWidth, vHeight) * 0.45;
            const startX = (vWidth - scanSize) / 2, startY = (vHeight - scanSize) / 2;
            canvas.width = scanSize; canvas.height = scanSize;
            ctx.filter = 'grayscale(1) contrast(350%) brightness(110%)';
            ctx.drawImage(video, startX, startY, scanSize, scanSize, 0, 0, scanSize, scanSize);
            try {
                const { data: { text } } = await worker.recognize(canvas);
                const cleaned = text.replace(/[^0-9.]/g, '');
                const match = cleaned.match(/\d+\.\d{2}/) || cleaned.match(/\d+/);
                if (match) {
                    const price = parseFloat(match[0]);
                    currentTotal += price; scanHistory.push(price);
                    totalDisp.innerText = currentTotal.toFixed(2);
                    status.innerText = `Added: $${price.toFixed(2)}`;
                } else { status.innerText = "Read Failed"; }
            } catch (e) { status.innerText = "Error"; }
        };

        function undoLast() {
            if (scanHistory.length > 0) {
                const last = scanHistory.pop();
                currentTotal -= last;
                totalDisp.innerText = Math.max(0, currentTotal).toFixed(2);
                status.innerText = `Removed: $${last.toFixed(2)}`;
            }
        }

        function resetTotal() { if(confirm("Clear?")) location.reload(); }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
        }
        init();
    </script>
</body>
</html>