<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceScan PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px; background: #f4f4f9; text-align: center; }
        #video-container { position: relative; width: 100%; max-width: 400px; margin: auto; border-radius: 15px; overflow: hidden; background: #000; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        video { width: 100%; display: block; }
        #overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 220px; height: 80px; border: 2px solid #28a745; pointer-events: none; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); }
        .dashboard { margin-bottom: 20px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #total-display { font-size: 3rem; font-weight: bold; color: #28a745; margin: 5px 0; }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        button { padding: 18px; font-size: 18px; cursor: pointer; border-radius: 10px; border: none; background: #28a745; color: white; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.98); opacity: 0.9; }
        #item-list { list-style: none; padding: 0; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        li { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div class="dashboard">
        <small>TOTAL COST</small>
        <div id="total-display">$0.00</div>
    </div>

    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="overlay"></div>
    </div>

    <div class="controls">
        <button id="scan-btn">SCAN PRICE</button>
        <div id="status">Point at price and tap scan</div>
    </div>

    <ul id="item-list"></ul>
    <button onclick="clearAll()" style="background:#666; font-size: 14px; margin-top: 20px;">Clear List</button>

    <script>
        // --- SCANNING LOGIC ---
        const video = document.getElementById('video');
        const scanBtn = document.getElementById('scan-btn');
        const totalDisplay = document.getElementById('total-display');
        let grandTotal = 0;

        async function initCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
        }

        async function performScan() {
            scanBtn.innerText = "READING...";
            scanBtn.disabled = true;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            try {
                const result = await Tesseract.recognize(canvas, 'eng');
                const match = result.data.text.match(/\d+\.\d{2}/);
                if (match) {
                    const price = parseFloat(match[0]);
                    grandTotal += price;
                    totalDisplay.innerText = `$${grandTotal.toFixed(2)}`;
                    const li = document.createElement('li');
                    li.innerHTML = `<span>Item</span><strong>$${price.toFixed(2)}</strong>`;
                    document.getElementById('item-list').prepend(li);
                }
            } catch (e) { console.error(e); }
            
            scanBtn.innerText = "SCAN PRICE";
            scanBtn.disabled = false;
        }

        function clearAll() {
            grandTotal = 0;
            totalDisplay.innerText = "$0.00";
            document.getElementById('item-list').innerHTML = "";
        }

        scanBtn.addEventListener('click', performScan);
        window.addEventListener('load', initCamera);

        // --- PWA SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(() => console.log("Service Worker Registered"));
        }
    </script>
</body>
</html>